# Update package repositories
pkgin -fy update

# Install prerequisites
pkgin -y install gcc47 gmake ruby193

# Install Chef
gem install --no-ri --no-rdoc chef

# Create Chef config directory
mkdir -p /etc/chef

# Install Chef validator
awk NF > /etc/chef/validation.pem << 'EOP'
<%= validation_key %>
EOP
chmod 0600 /etc/chef/validation.pem

# Install Chef client config
cat > /etc/chef/client.rb <<'EOP'
<%= config_content %>
EOP

# Install Chef first boot file
cat > /etc/chef/first-boot.json <<'EOP'
<%= first_boot.to_json %>
EOP

# Run chef for the first time
chef-client -j /etc/chef/first-boot.json

