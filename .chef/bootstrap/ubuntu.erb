bash -c '

# Disable IPv6
sysctl net.ipv6.conf.all.disable_ipv6=1
sysctl net.ipv6.conf.default.disable_ipv6=1
sysctl net.ipv6.conf.lo.disable_ipv6=1

# Update package repositories
apt-get update

# Touch bootstrapping lock file
touch /tmp/bootstrap.lck

# Install Chef
wget -qO /tmp/chef.deb https://opscode-omnibus-packages.s3.amazonaws.com/ubuntu/13.04/x86_64/chef_11.16.0-1_amd64.deb
dpkg -i /tmp/chef.deb

# Create Chef config directory
mkdir -p /etc/chef

# Install Chef validator
awk NF > /etc/chef/validation.pem << 'EOP'
<%= validation_key %>
EOP
chmod 0600 /etc/chef/validation.pem

# Install Chef client config
cat > /etc/chef/client.rb <<'EOP'
<%= config_content %>
EOP

# Install Chef encrypted data bag secret
( cat <<'EOP'
<%= IO.read(Chef::Config[:knife][:encrypted_data_bag_secret]) %>
EOP
) > /tmp/encrypted_data_bag_secret
awk NF /tmp/encrypted_data_bag_secret > /etc/chef/encrypted_data_bag_secret
rm /tmp/encrypted_data_bag_secret

# Install Chef first boot file
cat > /etc/chef/first-boot.json <<'EOP'
<%= first_boot.to_json %>
EOP

# Run chef for the first time
<%= start_chef %>

# Remove bootstrapping lock file
rm /tmp/bootstrap.lck

'
