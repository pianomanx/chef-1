- name: openvpn-client
  docker_container:
    name: openvpn-client
    image: dperson/openvpn-client
    pull: true
    memory: 16M
    memory_swap: unlimited
    capabilities:
      - net_admin
    devices:
      - /dev/net/tun:/dev/net/tun:rwm
    dns_servers:
      - 8.8.8.8
      - 8.8.4.4
    volumes:
      - /opt/config/openvpn/client:/vpn:ro
    privileged: true
    restart_policy: always

- name: nzbget
  docker_container:
    name: nzbget
    image: linuxserver/nzbget
    pull: true
    memory: 512M
    memory_swap: unlimited
    network_mode: container:openvpn-client
    env:
      PGID: "65534"
      PUID: "65534"
    volumes:
      - /opt/config/nzbget:/config:rw
      - /data/shares/Downloads:/downloads:rw
    restart_policy: always

- name: lidarr
  docker_container:
    name: lidarr
    image: linuxserver/lidarr
    pull: true
    memory: 512M
    memory_swap: unlimited
    network_mode: container:openvpn-client
    env:
      PGID: "65534"
      PUID: "65534"
    volumes:
      - /opt/config/lidarr:/config:rw
      - /data/shares/Media/Music:/music:rw
      - /data/shares/Downloads:/downloads:rw
    restart_policy: always

- name: qbittorrent
  docker_container:
    name: qbittorrent
    image: linuxserver/qbittorrent
    pull: true
    memory: 512M
    memory_swap: unlimited
    network_mode: container:openvpn-client
    env:
      PGID: "65534"
      PUID: "65534"
    volumes:
      - /opt/config/qbittorrent:/config:rw
      - /data/shares/Downloads:/downloads:rw
    restart_policy: always

- name: radarr
  docker_container:
    name: radarr
    image: linuxserver/radarr
    pull: true
    memory: 512M
    memory_swap: unlimited
    network_mode: container:openvpn-client
    env:
      PGID: "65534"
      PUID: "65534"
    volumes:
      - /opt/config/radarr:/config:rw
      - /data/shares/Media:/media:rw
      - /data/shares/Downloads:/downloads:rw
    restart_policy: always

- name: sonarr
  docker_container:
    name: sonarr
    image: linuxserver/sonarr
    pull: true
    memory: 512M
    memory_swap: unlimited
    network_mode: container:openvpn-client
    env:
      PGID: "65534"
      PUID: "65534"
    volumes:
      - /opt/config/sonarr:/config:rw
      - /data/shares/Media/TV:/tv:rw
      - /data/shares/Media/TV_Children:/children:rw
      - /data/shares/Downloads:/downloads:rw
    restart_policy: always

- name: samba
  docker_container:
    name: samba
    image: dockurr/samba
    pull: true
    memory: 512M
    memory_swap: unlimited
    network_mode: host
    env:
      NMBD: "true"
    volumes:
      - /data/shares:/shares:rw
      - /opt/config/samba/smb.conf:/etc/samba/smb.conf:rw
      - /opt/config/samba/users.conf:/etc/samba/users.conf:rw
    restart_policy: always

- name: makemkv
  docker_container:
    name: makemkv
    image: jlesage/makemkv
    pull: true
    devices:
      - /dev/sr0:/dev/sr0:rwm
      - /dev/sg3:/dev/sg3:rwm
    volumes:
      - /opt/config/makemkv:/config:rw
      - /data/shares/Media:/output:rw
      - /data/shares/Downloads:/storage:rw
    restart_policy: always

- name: plex
  docker_container:
    name: plex
    image: plexinc/pms-docker
    pull: true
    memory: 4096M
    memory_swap: unlimited
    network_mode: host
    env:
      TZ: "America/New_York"
      CHANGE_CONFIG_DIR_OWNERSHIP: "false"
      PLEX_UID: "65534"
      PLEX_GID: "65534"
    devices:
      - /dev/dri/card1:/dev/dri/card1:rwm
      - /dev/dri/renderD128:/dev/dri/renderD128:rwm
    volumes:
      - /opt/config/plex:/config:rw
      - /data/shares/Media:/media:rw
      - /tmp:/tmp:rw
    restart_policy: always

- name: minecraft
  docker_container:
    name: minecraft
    image: itzg/minecraft-bedrock-server
    pull: true
    memory: 8192M
    memory_swap: unlimited
    network_mode: host
    interactive: true
    tty: true
    env:
      GID: "65534"
      UID: "65534"
      EULA: "true"
    volumes:
      - /opt/config/minecraft:/data:rw
    restart_policy: always

- name: tautulli
  docker_container:
    name: tautulli
    image: linuxserver/tautulli
    pull: true
    memory: 256M
    memory_swap: unlimited
    env:
      PGID: "65534"
      PUID: "65534"
    volumes:
      - /opt/config/tautulli:/config:rw
      - "/opt/config/plex/Library/Application Support/Plex Media Server/Logs:/logs"
    restart_policy: always

- name: nginx
  docker_container:
    name: nginx
    image: nginx
    pull: true
    memory: 512M
    memory_swap: unlimited
    ports:
      - "80:80"
      - "443:443"
    links:
      - openvpn-client:lidarr
      - openvpn-client:radarr
      - openvpn-client:nzbget
      - openvpn-client:sonarr
      - openvpn-client:qbittorrent
      - makemkv:makemkv
      - tautulli:tautulli
    volumes:
      - /opt/config/nginx:/etc/nginx:rw
      - /data/shares/Downloads:/downloads:rw
    restart_policy: always

- name: base
  docker_image:
    name: base
    build:
      path: /opt/config/ansible/dockerfiles/base
    tag: latest
    source: build

- name: plex-cleaner
  docker_container:
    name: plex-cleaner
    image: nitrikx/plex-cleaner
    pull: true
    memory: 256M
    memory_swap: unlimited
    env:
      EXECUTION_CRON_EXPRESSION: "22 */2 * * *"
    volumes:
      - /opt/config/plex-cleaner:/config:rw
      - /data/shares/Media:/media:rw
    restart_policy: always

- name: certbot
  docker_image:
    name: certbot/dns-route53:latest
    source: pull

- name: prune
  docker_prune:
    containers: true
    images: true
    volumes: true

